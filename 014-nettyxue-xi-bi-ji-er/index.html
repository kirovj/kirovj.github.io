<!DOCTYPE html>
<html lang="en">
  
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Netty学习笔记(二) &middot; Kirovj&#x27;s Chaos</title>
    <meta name="description" content="" />
    <link rel="shortcut icon"  href="https://kirovj.github.io/favicon.ico" />
    <link rel="alternate" type="application/atom+xml" title="RSS" href="https://kirovj.github.io/atom.xml">

    <style>html,body{background:#fffaf7;color:#2d2d2d;font:16px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}a,a:visited{color:darkred;text-decoration:none}a:hover{text-decoration:underline}main{margin:auto;max-width:38rem;padding:.8rem}pre{background:#fff;overflow:scroll;padding:1rem}td{border:1px solid #2d2d2d;padding:10px}img{height:auto;max-width:100%}.homepage-list{list-style:none;padding:1rem 0}.homepage-list li{align-items:center;display:flex;flex-wrap:wrap;justify-content:space-between;margin-bottom:10px}@media (max-width: 38rem){.homepage-list li a{width:100%}}</style>

    <meta property="og:site_name" content="Kirovj&#x27;s Chaos">
      <meta name="author" content="Kirovj" />
      <meta property="og:title" content="Netty学习笔记(二)">
      <meta property="og:description" content="">
      <meta property="og:url" content="https://kirovj.github.io/014-nettyxue-xi-bi-ji-er/">
      <meta property="og:image" content="">

      <meta property="og:type" content="article" />
        <meta property="article:published_time" content="2021-07-17T00:00:00+00:00" />

      
      
    

  </head>
  

  <body>
    <main id="main" role="main">

      
      <header role="banner">
        <h3 style="margin-top:0;">
          <a href="https://kirovj.github.io" title="Home">Kirovj&#x27;s Chaos</a>
          <br /><small></small>
        </h3>
      </header>
      <hr />
      

      
<article>
  <h1>Netty学习笔记(二)</h1>

  
    <p style="font-size:90%;">Posted on <time datetime="2021-07-17T00:00:00+00:00">July 17, 2021</time></p>
  

  <blockquote>
<p>Thanks to <a href="https://waylau.gitbooks.io/netty-4-user-guide/content/">https://waylau.gitbooks.io/netty-4-user-guide/content/</a></p>
<p>code at <a href="https://github.com/kirovj/winter">https://github.com/kirovj/winter</a></p>
</blockquote>
<h2 id="make-a-time-server-client">Make a Time Server &amp; Client</h2>
<hr />
<h3 id="server">Server</h3>
<p><em>TimeServer.java</em></p>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">TimeServer </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// port to listen
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final int </span><span style="color:#eff1f5;">port;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#8fa1b3;">TimeServer</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">port</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.port </span><span>=</span><span style="color:#eff1f5;"> port;
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">run</span><span style="color:#eff1f5;">() </span><span style="color:#b48ead;">throws </span><span style="color:#ebcb8b;">Exception </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">        </span><span style="color:#ebcb8b;">EventLoopGroup</span><span style="color:#eff1f5;"> bossGroup </span><span>= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">NioEventLoopGroup</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        </span><span style="color:#ebcb8b;">EventLoopGroup</span><span style="color:#eff1f5;"> workerGroup </span><span>= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">NioEventLoopGroup</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">try </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">ServerBootstrap</span><span style="color:#eff1f5;"> b </span><span>= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ServerBootstrap</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">            b.</span><span style="color:#bf616a;">group</span><span style="color:#eff1f5;">(bossGroup, workerGroup)
</span><span style="color:#eff1f5;">                    .</span><span style="color:#bf616a;">channel</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">NioServerSocketChannel</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">class</span><span style="color:#eff1f5;">)
</span><span style="color:#eff1f5;">                    .</span><span style="color:#bf616a;">childHandler</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ChannelInitializer</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">SocketChannel</span><span style="color:#eff1f5;">&gt;() {
</span><span style="color:#eff1f5;">                        @</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">                        </span><span style="color:#b48ead;">protected void </span><span style="color:#8fa1b3;">initChannel</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">SocketChannel </span><span style="color:#bf616a;">ch</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">                            ch.</span><span style="color:#bf616a;">pipeline</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">addLast</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">TimeEncoder</span><span style="color:#eff1f5;">(), </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">TimeServerHandler</span><span style="color:#eff1f5;">());
</span><span style="color:#eff1f5;">                        }
</span><span style="color:#eff1f5;">                    })
</span><span style="color:#eff1f5;">                    .</span><span style="color:#bf616a;">option</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ChannelOption</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">SO_BACKLOG</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">128</span><span style="color:#eff1f5;">)
</span><span style="color:#eff1f5;">                    .</span><span style="color:#bf616a;">childOption</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ChannelOption</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">SO_KEEPALIVE</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 绑定端口，开始接收进来的连接
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">ChannelFuture</span><span style="color:#eff1f5;"> f </span><span>=</span><span style="color:#eff1f5;"> b.</span><span style="color:#bf616a;">bind</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.port). </span><span style="color:#bf616a;">sync</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 等待服务器  socket 关闭 。
</span><span style="color:#eff1f5;">            f.</span><span style="color:#bf616a;">channel</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">closeFuture</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">sync</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        } </span><span style="color:#b48ead;">finally </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">            workerGroup.</span><span style="color:#bf616a;">shutdownGracefully</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">            bossGroup.</span><span style="color:#bf616a;">shutdownGracefully</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public static void </span><span style="color:#8fa1b3;">main</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">String</span><span style="color:#b48ead;">[] </span><span style="color:#bf616a;">args</span><span style="color:#eff1f5;">) </span><span style="color:#b48ead;">throws </span><span style="color:#ebcb8b;">Exception </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">TimeServer</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">8080</span><span style="color:#eff1f5;">).</span><span style="color:#bf616a;">run</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">}
</span></code></pre>
<blockquote>
<p>不同于之前，将UnixTime对象作为数据传输</p>
</blockquote>
<p><em>UnixTime.java</em></p>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">UnixTime </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final long </span><span style="color:#eff1f5;">value;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#8fa1b3;">UnixTime</span><span style="color:#eff1f5;">() {
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">System</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">currentTimeMillis</span><span style="color:#eff1f5;">() </span><span>/ </span><span style="color:#d08770;">1000</span><span style="color:#b48ead;">L </span><span>+ </span><span style="color:#d08770;">2208988800</span><span style="color:#b48ead;">L</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#8fa1b3;">UnixTime</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">long </span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.value </span><span>=</span><span style="color:#eff1f5;"> value;
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public long </span><span style="color:#8fa1b3;">value</span><span style="color:#eff1f5;">() {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;"> value;
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    @</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">String </span><span style="color:#8fa1b3;">toString</span><span style="color:#eff1f5;">() {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return new </span><span style="color:#ebcb8b;">Date</span><span style="color:#eff1f5;">((</span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">() </span><span>- </span><span style="color:#d08770;">2208988800</span><span style="color:#b48ead;">L</span><span style="color:#eff1f5;">) </span><span>* </span><span style="color:#d08770;">1000</span><span style="color:#b48ead;">L</span><span style="color:#eff1f5;">).</span><span style="color:#bf616a;">toString</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">}
</span></code></pre>
<p><em>TimeServerHandler.java</em></p>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">TimeServerHandler </span><span style="color:#b48ead;">extends </span><span style="color:#a3be8c;">ChannelInboundHandlerAdapter </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    @</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">channelActive</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ChannelHandlerContext </span><span style="color:#bf616a;">ctx</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#ebcb8b;">ChannelFuture</span><span style="color:#eff1f5;"> f </span><span>=</span><span style="color:#eff1f5;"> ctx.</span><span style="color:#bf616a;">writeAndFlush</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">UnixTime</span><span style="color:#eff1f5;">());
</span><span style="color:#eff1f5;">        f.</span><span style="color:#bf616a;">addListener</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ChannelFutureListener</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">CLOSE</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    @</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">exceptionCaught</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ChannelHandlerContext </span><span style="color:#bf616a;">ctx</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">Throwable </span><span style="color:#bf616a;">cause</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        cause.</span><span style="color:#bf616a;">printStackTrace</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        ctx.</span><span style="color:#bf616a;">close</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">}
</span></code></pre>
<blockquote>
<p>服务端直接返回 new UnixTime()</p>
</blockquote>
<blockquote>
<p>但虽然用对象进行传输，但是底层传输的还是bytes，所以也要对对象进行编码解码</p>
</blockquote>
<p><em>TimeEncoder.java</em></p>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#65737e;">// 编码器,是ChannelOutboundHandler的实现,用来将 UnixTime 对象重新转化为一个 ByteBuf
</span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">TimeEncoder </span><span style="color:#b48ead;">extends </span><span style="color:#a3be8c;">MessageToByteEncoder</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">UnixTime</span><span style="color:#eff1f5;">&gt; {
</span><span style="color:#eff1f5;">    @</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">protected void </span><span style="color:#8fa1b3;">encode</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ChannelHandlerContext </span><span style="color:#bf616a;">ctx</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">UnixTime </span><span style="color:#bf616a;">msg</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">ByteBuf </span><span style="color:#bf616a;">out</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        out.</span><span style="color:#bf616a;">writeInt</span><span style="color:#eff1f5;">((</span><span style="color:#b48ead;">int</span><span style="color:#eff1f5;">) msg.</span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">());
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">}
</span></code></pre>
<hr />
<h3 id="client">Client</h3>
<p><em>TimeClient.java</em></p>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">TimeClient </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public static void </span><span style="color:#8fa1b3;">main</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">String</span><span style="color:#b48ead;">[] </span><span style="color:#bf616a;">args</span><span style="color:#eff1f5;">) </span><span style="color:#b48ead;">throws </span><span style="color:#ebcb8b;">InterruptedException </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">        </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> host </span><span>= &quot;</span><span style="color:#a3be8c;">127.0.0.1</span><span>&quot;</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">int</span><span style="color:#eff1f5;"> port </span><span>= </span><span style="color:#d08770;">8080</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">        </span><span style="color:#ebcb8b;">EventLoopGroup</span><span style="color:#eff1f5;"> workerGroup </span><span>= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">NioEventLoopGroup</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">try </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// BootStrap 和 ServerBootstrap 类似,不过他是对非服务端的 channel 而言，比如客户端或者无连接传输模式的 channel。
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">Bootstrap</span><span style="color:#eff1f5;"> b </span><span>= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">Bootstrap</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 如果你只指定了一个 EventLoopGroup，那他就会即作为一个 boss group ，也会作为一个 workder group，尽管客户端不需要使用到 boss worker 。
</span><span style="color:#eff1f5;">            b.</span><span style="color:#bf616a;">group</span><span style="color:#eff1f5;">(workerGroup);
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 代替NioServerSocketChannel的是NioSocketChannel,这个类在客户端channel 被创建时使用。
</span><span style="color:#eff1f5;">            b.</span><span style="color:#bf616a;">channel</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">NioSocketChannel</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">class</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 不像在使用 ServerBootstrap 时需要用 childOption() 方法，因为客户端的 SocketChannel 没有父亲。
</span><span style="color:#eff1f5;">            b.</span><span style="color:#bf616a;">option</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ChannelOption</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">SO_KEEPALIVE</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            b.</span><span style="color:#bf616a;">handler</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ChannelInitializer</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">SocketChannel</span><span style="color:#eff1f5;">&gt;() {
</span><span style="color:#eff1f5;">                @</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">protected void </span><span style="color:#8fa1b3;">initChannel</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">SocketChannel </span><span style="color:#bf616a;">ch</span><span style="color:#eff1f5;">) </span><span style="color:#b48ead;">throws </span><span style="color:#ebcb8b;">Exception </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                    ch.</span><span style="color:#bf616a;">pipeline</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">addLast</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">TimeDecoder</span><span style="color:#eff1f5;">(), </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">TimeClientHandler</span><span style="color:#eff1f5;">());
</span><span style="color:#eff1f5;">                }
</span><span style="color:#eff1f5;">            });
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 启动客户端 我们用 connect() 方法代替了 bind() 方法。
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">ChannelFuture</span><span style="color:#eff1f5;"> f </span><span>=</span><span style="color:#eff1f5;"> b.</span><span style="color:#bf616a;">connect</span><span style="color:#eff1f5;">(host, port).</span><span style="color:#bf616a;">sync</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 等待连接关闭
</span><span style="color:#eff1f5;">            f.</span><span style="color:#bf616a;">channel</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">closeFuture</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">sync</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        } </span><span style="color:#b48ead;">finally </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">            workerGroup.</span><span style="color:#bf616a;">shutdownGracefully</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">}
</span></code></pre>
<blockquote>
<p>注意channel的pipeline中加了一个TimeDecoder</p>
</blockquote>
<blockquote>
<p>服务端编码，客户端解码</p>
</blockquote>
<p><em>TimeDecoder.java</em></p>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">TimeDecoder </span><span style="color:#b48ead;">extends </span><span style="color:#a3be8c;">ByteToMessageDecoder </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// ByteToMessageDecoder 是 ChannelInboundHandler 的一个实现类，他可以在处理数据拆分的问题上变得很简单
</span><span style="color:#eff1f5;">    @</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">protected void </span><span style="color:#8fa1b3;">decode</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ChannelHandlerContext </span><span style="color:#bf616a;">ctx</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">ByteBuf </span><span style="color:#bf616a;">in</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">List</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Object</span><span style="color:#eff1f5;">&gt; </span><span style="color:#bf616a;">out</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// 每当有新数据接收的时候，ByteToMessageDecoder 都会调用 decode() 方法来处理内部的那个累积缓冲。
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(in.</span><span style="color:#bf616a;">readableBytes</span><span style="color:#eff1f5;">() </span><span>&lt; </span><span style="color:#d08770;">4</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// Decode() 方法可以决定当累积缓冲里没有足够数据时可以往 out 对象里放任意数据
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 当有更多的数据被接收了 ByteToMessageDecoder 会再一次调用 decode() 方法。
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// 如果在 decode() 方法里增加了一个对象到 out 对象里，这意味着解码器解码消息成功
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// ByteToMessageDecoder 将会丢弃在累积缓冲里已经被读过的数据
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// 请记得你不需要对多条消息调用 decode()，ByteToMessageDecoder 会持续调用 decode() 直到不放任何数据到 out 里。
</span><span style="color:#eff1f5;">        out.</span><span style="color:#bf616a;">add</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">UnixTime</span><span style="color:#eff1f5;">(in.</span><span style="color:#bf616a;">readUnsignedInt</span><span style="color:#eff1f5;">()));
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">}
</span></code></pre>
<p><em>TimeClientHandler.java</em></p>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">TimeClientHandler </span><span style="color:#b48ead;">extends </span><span style="color:#a3be8c;">ChannelInboundHandlerAdapter </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    @</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">channelRead</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ChannelHandlerContext </span><span style="color:#bf616a;">ctx</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">Object </span><span style="color:#bf616a;">msg</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#ebcb8b;">UnixTime</span><span style="color:#eff1f5;"> time </span><span>= </span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">UnixTime</span><span style="color:#eff1f5;">) msg;
</span><span style="color:#eff1f5;">        </span><span style="color:#ebcb8b;">System</span><span style="color:#eff1f5;">.out.</span><span style="color:#bf616a;">println</span><span style="color:#eff1f5;">(time);
</span><span style="color:#eff1f5;">        ctx.</span><span style="color:#bf616a;">close</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    @</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">exceptionCaught</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ChannelHandlerContext </span><span style="color:#bf616a;">ctx</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">Throwable </span><span style="color:#bf616a;">cause</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        cause.</span><span style="color:#bf616a;">printStackTrace</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        ctx.</span><span style="color:#bf616a;">close</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">}
</span></code></pre>
<blockquote>
<p>将msg转为UnixTime对象</p>
</blockquote>

</article>


      
      <footer role="contentinfo">
        <hr />
        
        <nav style="margin-bottom:1rem;" role="navigation">
          
            <a href="https://kirovj.github.io/about">About</a>
            
              <span>&middot;</span>
            
          
            <a href="https://kirovj.github.io/atom.xml">RSS</a>
            
              <span>&middot;</span>
            
          
            <a href="https://github.com/kirovj">Github</a>
            
          
        </nav>
        
        
        <small>Built with <a href="https://www.getzola.org/">Zola</a>.<br />
          Maintained with &hearts; for the web.<br />
          
        </small>
        
      </footer>
      

    </main>
    
    
  </body>
</html>

